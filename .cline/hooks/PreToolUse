#!/usr/bin/env node
/**
 * .clinerules/hooks/PreToolUse
 * Intercepts 'run_command' to validate 'git commit' operations.
 */
const fs = require('fs');
const { execSync } = require('child_process');

// 1. Read Input (JSON from stdin)
let input = '';
process.stdin.on('data', chunk => input += chunk);
process.stdin.on('end', () => {
    const payload = JSON.parse(input);
    const response = { cancel: false };

    try {
        // 2. Check if it's a command execution
        if (payload.hookName === 'PreToolUse' && payload.preToolUse.toolName === 'run_command') {
            const params = payload.preToolUse.parameters;
            const command = params.commandLine || params.command;

            // 3. Intercept 'git commit'
            if (command && command.includes('git commit')) {
                
                // Extract commit message if possible (simple regex)
                const msgMatch = command.match(/-m\s+["'](.+?)["']/);
                const commitMsg = msgMatch ? msgMatch[1] : "unknown";

                // A. Validate Conventional Commits
                if (!/^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\([\w-]+\))?: .+/.test(commitMsg)) {
                    response.cancel = true;
                    response.errorMessage = `❌ BMAD Gatekeeper: Commit message "${commitMsg}" does not follow Conventional Commits.\nExpected: type(scope): description`;
                    console.log(JSON.stringify(response));
                    return;
                }

                // B. Validate Context Update (activeContext.md)
                try {
                    const staged = execSync('git diff --cached --name-only', { encoding: 'utf-8' });
                    const hasCode = staged.match(/\.(js|ts|jsx|tsx|py|rb|go|rs|java|c|cpp|h|hpp|css|scss|html|vue|svelte)$/m);
                    const hasContext = staged.includes('activeContext.md');

                    if (hasCode && !hasContext) {
                        response.cancel = true;
                        response.errorMessage = `❌ BMAD Gatekeeper: Code changes detected without 'activeContext.md' update.\nRule: You MUST update the project memory before committing code.`;
                        console.log(JSON.stringify(response));
                        return;
                    }
                } catch (e) {
                    // Git error or empty repo, ignore
                }
            }
        }
    } catch (error) {
        // Fail safe: allow operation if hook crashes, but log it
        // console.error("Hook Error:", error);
    }

    // 4. Output Response (JSON)
    console.log(JSON.stringify(response));
});
